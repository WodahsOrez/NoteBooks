# SQL调优

## 索引

索引的原理：加上索引后，查询表内被索引字段时就不会读取整张表所有字段的数据，而只需要进入索引字段单独的空间内去查询，从而提高效率。通常考虑对where和order by涉及的列增加索引。

### 使用注意

1. 对经常更新的表就避免设置过多的索引，对经常查询的字段应该创建索引。
2. 数据量小的表不要使用索引，效率会下降。
3. 在不同值较少的字段不要建立索引，在不同值较多的字段可以建立索引。
4. 索引会降低insert和update的效率，一个表索引最好不要超过6个
5. 不能用null做索引，任何包含null的列都将从索引中排除。

### 索引的种类

**单列索引**：一个索引只包含单个列，但一个表中可以有多个单列索引。

- **普通索引**：MySQL中基本索引类型，没有什么限制，允许在定义索引的列中插入重复值和空值，纯粹为了查询数据更快一点。
- **唯一索引**：索引列中的值必须是唯一的，但是允许为空值，
- **主键索引**：是一种特殊的唯一索引，不允许有空值。

**组合索引**：一个的索引包含多个列，只有在查询条件中使用了这些字段的左边字段时，索引才会被使用，使用组合索引时遵循最左前缀，即一个id、name和age3个字段构成的索引，只有查询字段是(id，name，age)、(id，name)或者(id)时才会触发该索引。

**强制查询使用索引**： 

```sql
select id from t with(index(索引名)) where num = @num
```

##  SQL优化

### 全表扫描

即使使用了索引，但有一些操作还是会导致全表扫描，应避免使用以下操作

- **模糊查询**：like的效率低，全模糊（'%...%'）是不能使用索引的，右模糊('...%')是可以使用索引的，左模糊('%...')是无法使用索引的，解决方式是用reverse函数转换成右模糊。
- **null做为判断条件**：尽量将字段的默认值设为0。is null 和 is not null不会使用索引。
- **不等于操作符（<>、!=）**：不等于会全表扫描，可以改成or，如column< 3 or column >3
- **避免使用or**：因为mysql一个select只能使用一个索引，当两边or都是不同索引时后一个索引不会被使用，用union all连接分开的两个条件
- 避免where子句中对字段进行表达式操作，函数操作，计算操作都会导致全表扫描
- **避免in 和not in**：对于连续的数值，使用between，对于子查询使用exists

### 其他优化

- 避免全字段update：如果只是需要修改一两个字段，就不要大量update
- 对于数据量大的表先分页后join
- 杜绝select count(*)不带任何条件的count会全盘扫描且没有意义。
- where子句顺序：能过滤掉最大数量记录的排前面。
- 避免使用*，只返回用到的字段。